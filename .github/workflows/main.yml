name: DevSecOps CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: my-app
  IMAGE_TAG: ${{ github.sha }}

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # Scan Terraform with tfsec (Docker)
    - name: tfsec Scan
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/terraform:/src \
          aquasec/tfsec /src

    # Terraform Init (Docker)
    - name: Terraform Init
      run: |
        docker run --rm 
          -v ${{ github.workspace }}/terraform:/workspace 
          -w /workspace 
          hashicorp/terraform:1.6 
          terraform init

    # Terraform Plan (Docker)
    - name: Terraform Plan
      run: |
        docker run --rm 
          -v ${{ github.workspace }}/terraform:/workspace 
          -w /workspace 
          hashicorp/terraform:1.6 
          terraform plan

    # Build Docker Image
    - name: Build Docker Image
      run: |
        docker build -t $IMAGE_NAME:$IMAGE_TAG .

    # Trivy Image Scan (Docker)
    - name: Trivy Scan
      run: |
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy image \
          --exit-code 1 --severity CRITICAL,HIGH \
          $IMAGE_NAME:$IMAGE_TAG

    # Set up kubeconfig
    - name: Set up Kubeconfig
      run: |
        echo "${{ secrets.KUBECONFIG }}" > kubeconfig
        export KUBECONFIG=$PWD/kubeconfig

    # Apply Sealed Secrets (with kubectl inside Docker)
    - name: Apply Sealed Secrets
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/manifests:/manifests \
          -v $PWD/kubeconfig:/root/.kube/config \
          bitnami/kubectl:latest apply -f /manifests/sealed-secret.yaml

    # Deploy App (with kubectl inside Docker)
    - name: Deploy to Kubernetes
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/manifests:/manifests \
          -v $PWD/kubeconfig:/root/.kube/config \
          bitnami/kubectl:latest apply -f /manifests/deployment.yaml
